"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = retrocycle;

var _typeof2 = _interopRequireDefault(require("@babel/runtime/helpers/typeof"));

var _reviver = _interopRequireDefault(require("./reviver"));

var _util = require("./util");

var _constants = require("../constants");

// eslint-disable-next-line no-control-regex
var pathReg = /^\$(?:\[(?:\d+|"(?:[^\\"\u0000-\u001f]|\\([\\"/bfnrt]|u[0-9a-zA-Z]{4}))*")])*$/;

function retrocycle(json) {
  var $ = JSON.parse(json, _reviver.default);

  if ((0, _typeof2.default)($) !== 'object' || $ === null) {
    return $;
  }

  (function rez(value) {
    if (value && (0, _typeof2.default)(value) === 'object') {
      if (Array.isArray(value)) {
        for (var i = 0; i < value.length; i += 1) {
          var item = value[i];

          if (item && (0, _typeof2.default)(item) === 'object') {
            var path = item.$ref;

            if (typeof path === 'string' && pathReg.test(path)) {
              value[i] = eval(path); // eslint-disable-line no-eval, no-param-reassign
            } else {
              rez(item);
            }
          }
        }
      } else {
        // eslint-disable-next-line no-restricted-syntax, guard-for-in
        for (var name in value) {
          var _item = value[name];

          if ((0, _typeof2.default)(_item) === 'object' && _item !== null) {
            var _path = _item.$ref;

            if (typeof _path === 'string' && pathReg.test(_path)) {
              value[name] = eval(_path); // eslint-disable-line no-eval, no-param-reassign
            } else {
              rez(_item);
            }
          }
        }
      }
    }
  })($);

  (0, _util.muteProperty)(_constants.CYCLIC_KEY, $);
  return $;
}